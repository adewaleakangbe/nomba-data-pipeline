name: dbt + Mongo→Postgres CI Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  pipeline:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: nomba
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d nomba"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

      mongo:
        image: mongo:6
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongo --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      # -------------------------------
      # Step 1: Run Mongo → Postgres ETL
      # -------------------------------
      - name: Install Mongo→Postgres dependencies
        working-directory: ./services/mongo_to_postgres
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Mongo→Postgres ETL
        working-directory: ./services/mongo_to_postgres
        run: python mongo_to_postgres.py

      # -------------------------------
      # Step 2: dbt CI
      # -------------------------------
      - name: Install dbt (core + postgres adapter)
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core dbt-postgres

      - name: Wait for Postgres to be ready
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
        run: |
          for i in {1..20}; do
            pg_isready -h localhost -p 5432 -U postgres && break
            sleep 1
          done

      - name: Create DB/schema needed for dbt
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
        run: |
          psql -h localhost -U postgres -c "CREATE DATABASE nomba;" || true
          psql -h localhost -U postgres -d nomba -c "CREATE SCHEMA IF NOT EXISTS analytics;" || true

      - name: Configure dbt profile from secret
        run: |
          mkdir -p ~/.dbt
          echo "$DBT_PROFILE" > ~/.dbt/profiles.yml
        env:
          DBT_PROFILE: ${{ secrets.DBT_PROFILE }}

      - name: Show dbt version
        run: dbt --version

      - name: Install dbt dependencies
        working-directory: ./dbt/nomba_analytics
        run: dbt deps --profiles-dir ~/.dbt

      - name: Run dbt (compile + run + tests)
        run: |
          dbt compile --profiles-dir ~/.dbt --project-dir dbt/nomba_analytics
          dbt run --profiles-dir ~/.dbt --project-dir dbt/nomba_analytics
          dbt test --profiles-dir ~/.dbt --project-dir dbt/nomba_analytics

